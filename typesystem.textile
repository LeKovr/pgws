h1. Типы данных и правила валидации

{{toc}}

h2. Введение

Реализация программного интерфейса к методам системы предусматривает описание аргументов методов и возвращаемых ими результатов.

Такое описание должно содержать следующую информацию:

*Аргументы методов*
_для каждого аргумента_
* имя аргумента
* описание аргумента
* правила валидации

*Результаты методов*
* описание структуры

Информация должна быть представлена в виде, позволяющем реализовать: 
* подержку валидации аргументов на стороне сервера и клиента
* визуализацию результатов на стороне клиента
* в перспективе - описание API в форматах, поддерживаемых клиентским ПО (SMD, WSDL и т.п.)

Описание правил валидации аргументов и структуры результатов основано на понятии *тип данных*.

В качестве базового документа при проектировании использован "XML Schema Part 2: Datatypes Second Edition":http://www.w3.org/TR/xmlschema-2

h2. Определения

Типы данных подразделяются на
* атом - значения данного типа неделимы
* список - последовательность (возможно пустая) значений атомарного типа
* объединение - одно или более значений других типов

* Примитивные (базовые) - не определены в терминах других типов данных, они существуют с самого начала.
* Производные - определены в терминах других типов данных.

* Встроенные - определены в этой спецификации, могут быть примитивными или производными
* Пользовательские - определены при проектировании методов API

В описание типа данных может быть включено ограничение (constraining facet) - опциональное свойство, которое применяется к типу данных для ограничения его пространства значений.

*Примитивные (базовые) типы данных:*

_поддержка этих типов должна быть зашита в код валидаторов_
# text
# bool
# decimal
# interval
# timestamp
# time
# date
# inet

*Производные типы данных*

_валидация этих типов производится аналогично пользовательским типам_
# gYearMonth
# gYear
# gMonthDay
# gDay
# gMonth
# token
# language
# normalizedString
# Name ( ::= (Letter | '_' | ':') ( NameChar)*)
# NCName  ( ::=  (Letter | '_') (NCNameChar)*
# integer
# long
# int
# short
# byte
# nonNegativeInteger
# unsignedLong
# unsignedInt
# unsignedShort
# unsignedByte
# positiveInteger
# anyURI
# email
# www

*Ограничения*

# length
# minLength
# maxLength
# pattern
# enumeration
# whiteSpace (preserve|replace|collapse)
# maxInclusive
# maxExclusive
# minExclusive
# minInclusive
# totalDigits
# fractionDigits

h2. Схема данных

!ws_dt.png!
рис 1. Схема данных подсистемы описания типов

h2. Пример данных

h3. facet. Ограничения

|_.id|_.code|_.anno|
|1|length|Длина|
|2|minLength|Мин. длина|
|3|maxLength|Макс. длина|
|4|pattern|Шаблон|
|5|enumeration|Список значений|
|6|whiteSpace|Обработка пробелов|
|7|maxInclusive|Не больше|
|8|maxExclusive|Меньше|
|9|minExclusive|Больше|
|10|minInclusive|Не меньше|
|11|totalDigits|Количество знаков|
|12|fractionDigits|Знаков дробной части|

h3. dt. Типы

|_.id|_.part_id|_.code|_.parent_id|_.base_id|_.allow_null|_.def_val|_.anno|_.is_list|_.is_complex|_.is_sql|
|1|0|text|1|1|t||Текст|f|f|f|
|2|0|boolean|2|2|t||Да/Нет|f|f|f|
|3|0|decimal|3|3|t||Число|f|f|f|
|4|0|interval|4|4|t||Интервал|f|f|f|
|5|0|timestamp|5|5|t||Момент|f|f|f|
|6|0|time|6|6|t||Время|f|f|f|
|7|0|date|7|7|t||Дата|f|f|f|
|8|0|inet|8|8|t||ip адрес|f|f|f|
|100|0|int|1|3|t||Целое|f|f|f|
|101|0|id32|100|3|t||Короткое целое|f|f|f|
|103|0|class|101|3|t||Класс|f|f|f|
|104|0|non_neg_int|100|3|f||Неотрицательное целое|f|f|f|
|105|0|code|1|1|f||Имя переменной|f|f|f|
|106|0|codei|1|1|f||Имя переменной в любом регистре|f|f|f|
|107|0|code_like|1|1|f||Шаблон имени переменной|f|f|f|
|108|0|err_code|1|1|f||Код ошибки|f|f|f|
|110|0|hashtable|||f||Хэштаблица|f|t|f|
|110|1|id|101|3|f||ID|f|f|f|
|110|2|name|1|1|f||Название|f|f|f|
|111|0|acl|101|3|t||Уровень доступа|f|f|f|
|112|0|acls|101|3|t||Уровни доступа|t|f|f|

h3. dt_facet. Ограничения типов

<pre>
   | id  | facet_id |                        value                        | base_id |               anno                |
   |-----+----------+-----------------------------------------------------+---------+-----------------------------------|
   |   2 |        4 | ^([01tf]|on|off)$                                   |       2 | только 0,1,t,f,on или off         | 
   |   3 |        4 | ^(\+|\-)?(\d)*(\.\d+)?$                             |       3 | [знак]целая часть[.дробная часть] | 
   |   7 |        4 | ^\d{1,2}\.\d{2}\.\d{4}$                             |       7 | ДД.ММ.ГГГГ                        | 
   |  11 |       10 | -2147483648                                         |      11 |                                   | 
   |  11 |        7 | 2147483647                                          |      11 |                                   | 
   |  11 |        4 | ^(\+|\-)?\d+$                                       |      11 | [знак]цифры                       | 
   |  12 |        7 | 32767                                               |      12 |                                   | 
   |  12 |        4 | ^(\+|\-)?\d+$                                       |      12 | [знак]цифры                       | 
   |  12 |       10 | -32768                                              |      12 |                                   | 
   |  13 |        4 | ^d+$                                                |      13 |                                   | 
   | 104 |        9 | 0                                                   |       3 |                                   | 
   | 107 |        4 | ^[a-z\d_][a-z\d\.\-_/]+$                            |       1 |                                   | 
   | 109 |       10 | 0                                                   |      11 |                                   | 
   | 112 |        4 | ^[a-z\d][a-z\d\.\-_]*$                              |       1 |                                   | 
   | 113 |        4 | ^[a-z\d_][a-z\d\.\-_]*$                             |       1 |                                   | 
   | 114 |        4 | ^[a-z\d][a-z\d\.\-_A-Z]*$                           |       1 |                                   | 
   | 115 |        4 | ^[a-z\d\.\-_%]+$                                    |       1 |                                   | 
   | 116 |        4 | ^([a-z\d][a-z\d\.\-_]+)|([A-Z\d][a-z\d\.\-_:A-Z]+)$ |       1 |                                   | 
   | 117 |        1 | 5                                                   |       1 |                                   | 
</pre>